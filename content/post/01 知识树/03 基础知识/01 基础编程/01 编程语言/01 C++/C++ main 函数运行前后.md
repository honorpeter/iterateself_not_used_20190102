---
title: C++ main 函数运行前后
toc: true
date: 2018-08-03 19:34:31
---

# main 函数运行前后


## main 函数运行前发生了什么？

我们通常认为 C 语言的起始函数是`main()`函数，实质上一个程序的启动函数并不一定是`main()`函数，这个可以采用链接器来设置，但是 gcc 中默认`main()`就是C语言的入口函数，在 `main()`函数启动之前，内核会调用一个特殊的启动例程，这个启动例程从内核中取得命令行参数值和环境变量值，为调用`main()`函数做好准备。

因此对应程序而言`main()`函数并不是起始，但是对应 C 语言而言，`main()`函数就是入口地址。

<span style="color:red;">对上面的说法半信半疑，还是要找到权威的说明确认下。</span>


## main()函数执行完后发生了什么？

### main 结束，整个进程就结束了吗？

main结束，不代表整个进程结束。

<span style="color:red;">下面这段估计也是博客作者从别的地方整理来的，有些重复，还是要找权威的资料确认下的。</span>

1. 全局对象的构造函数会在 main 函数之前执行。全局对象的析构函数会在main函数之后执行；    用atexit注册的函数也会在main之后执行。
2. 一些全局变量、对象和静态变量、对象的空间分配和赋初值就是在执行 main 函数之前，而 main 函数执行完后，还要去执行一些诸如释放空间、释放资源使用权等操作
3. 进程启动后，要执行一些初始化代码（如设置环境变量等），然后跳转到 main 执行。全局对象的构造也在main之前。


### atexit 的运行情况

按照 ISO C 的规定，一个进程可以登记多达 32 个函数，这些函数将由 exit 自动调用，通常这 32 个函数被称为终止处理程序，并调用`atexit()`函数来登记这些函数。 (函数的调用顺序与注册的顺序是相反的，通过下面的实例可以看出来)<span style="color:red;">一个进程智能登记32个函数吗？什么意思？找一些权威的资料确认下。</span>

代码如下：

```cpp
#include<stdio.h>
#include<stdlib.h>
void fun1(void)
{
  	printf("fun1\n");
}
void fun2(void)
{
  	printf("fun2\n");
}
void fun3(void)
{
  	printf("fun3\n");
}

int main()
{

  	// 注册需要在 main 函数结束后执行的函数.
  	// 请注意它们的注册顺序和执行顺序
  	// 在 main 函数结束后被调用，调用顺序与注册顺序相反。 先注册后执行。

  	atexit(fun1);
  	atexit(fun2);
  	atexit(fun3);
  	printf("main exit\n");
  	return 0;
}
```


运行结果：

![mark](http://images.iterate.site/blog/image/180803/7H5b81CkAe.png?imageslim)

说明：

头文件：`#include <stdlib.h>`定义函数：`int atexit(void (*func)(void));`;`atexit()`用来设置一个程序正常结束前调用的函数. 当程序通过调用`exit()`或从`main()`中返回时, 参数`function` 所指定的函数会先被调用, 然后才真正由`exit()`结束程序。

atexit 函数是标准 C 新增的。它“注册”一个函数，使这个函数将在 exit 函数被调用时或者当 mian 函数返回时被调用。当程序异常终止时（例如调用 abort 或 raise），通过它注册的函数并不会被调用。编译器必须至少允许程序员注册32个函数。如果注册成功，atexit 返回0，否则返回非零值。没有办法取消一个函数的注册。在 exit 所执行的任何标准清理操作之前，被注册的函数按照与注册顺序相反的顺序被依次调用。每个被调用的函数不接受任何参数，并且返回类型是 void。被注册的函数不应该试图引用任何存储类别为 auto 或 register 的对象（例如通过指针），除非是它自己所定义的。多次注册同一个函数将导致这个函数被多次调用。有些传统 C 编译器用 onexit 这个名称实现了像是的功能。

atexit是注册后进先出的函数，和函数入栈出栈是一样的。

在这里注册了四个函数，理解为入栈的顺序为fn1() -> fn2() -> fn3() -> fn4();出栈的顺序正好相反，而什么时候出栈呢？就是在调用函数结束时，准确的说应该是函数调用的最后的操作就是出栈过程。main()同样也是一个函数，在结束时，按出栈的顺序调用四个函数，即为fn4() -> fn3() -> fn2() -> fn1();

注册这个函数的目的就是为了在函数退出时调用的，即使是main()函数也是这样的。可以在这些函数中加入一些清理工作，比如内存释放等等。


<span style="color:red;">上面这几段没有看，找权威资料确认下。</span>







## 相关资料

- [C++面试题： main函数执行完之后还会调用其他的函数吗？](https://blog.csdn.net/rl529014/article/details/51671270)

- [main函数执行前、后再执行的代码](https://blog.csdn.net/huang_xw/article/details/8542105)
